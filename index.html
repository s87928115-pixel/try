<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Japan Trip 2026 (å®Œæ•´ç‰ˆ)</title>
    
    <link rel="apple-touch-icon" id="appIcon" href="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80">
    <link rel="shortcut icon" id="favIcon" href="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#fcfaf2',
                            card: '#ffffff',
                            text: '#4a4a4a',
                            accent: '#2c5d63',
                            secondary: '#8c8c8c',
                            border: '#e6e6e6',
                            highlight: '#d4493e',
                            planA: '#5c7c8a',
                            planB: '#c47c6e',
                            leave: '#718096', // é›¢é–‹é¡è‰²
                            join: '#e53e3e'   // åŠ å…¥é¡è‰²
                        }
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles */
        body {
            background-color: #fcfaf2;
            color: #4a4a4a;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .page-container {
            padding-bottom: 90px;
            min-height: 100vh;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .page-container.active {
            display: block;
            opacity: 1;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .muji-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .muji-btn {
            background-color: #2c5d63;
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            transition: opacity 0.2s;
        }
        .muji-btn:active { opacity: 0.8; }

        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background-color: #e5e5e5;
            z-index: 0;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            background-color: #2c5d63;
            border-radius: 50%;
            border: 2px solid white;
            z-index: 10;
            position: relative;
        }

        .muji-input {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            width: 100%;
            background: #fafafa;
            outline: none;
        }
        .muji-input:focus { border-color: #2c5d63; background: white; }

        /* FIXED STICKY HEADER */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 999;
            background-color: #2c5d63; 
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            padding-top: 10px;
        }
        
        .day-tabs-container {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 10px 16px;
            align-items: center;
        }
        
        .day-tab {
            flex: 0 0 auto;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .day-tab.active {
            background-color: white;
            color: #2c5d63;
            transform: scale(1.1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Cover & Gallery */
        #cover-area {
            height: 180px;
            background-size: cover;
            background-position: center;
            background-color: #ddd;
            position: relative;
        }
        #cover-gradient {
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4));
            position: absolute; top:0; left:0; right:0; bottom:0;
        }

        .weather-badge {
            display: inline-flex;
            align-items: center;
            background-color: #eef2f3;
            color: #555;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .schedule-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 8px; }
        .schedule-table th { text-align: left; background-color: #f5f5f5; padding: 6px; color: #2c5d63; }
        .schedule-table td { border-bottom: 1px solid #eee; padding: 6px; }
        .tag-a { background-color: #5c7c8a; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .tag-b { background-color: #c47c6e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        
        /* Smooth Scroll Padding */
        .scroll-mt-custom { scroll-margin-top: 140px; }
    </style>
</head>
<body class="font-sans antialiased text-muji-text">

    <div id="app" class="max-w-md mx-auto relative bg-muji-bg min-h-screen shadow-2xl">

        <div id="cover-area" style="background-image: url('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');">
            <div id="cover-gradient"></div>
            <div class="absolute bottom-4 left-4 text-white z-10">
                <h1 class="text-2xl font-bold tracking-widest text-shadow">JAPAN 2026</h1>
                <div class="text-xs opacity-90" id="globalWeather">Today: æ±äº¬ â›… 8Â°C</div>
                <div class="text-[10px] bg-white/20 px-2 py-0.5 rounded inline-block mt-1">Full Trip (11 Days)</div>
            </div>
            <label class="absolute bottom-4 right-4 bg-white/30 backdrop-blur-md p-2 rounded-full cursor-pointer hover:bg-white/50 z-20">
                <i class="fa-solid fa-camera text-white"></i>
                <input type="file" accept="image/*" class="hidden" onchange="changeCover(this)">
            </label>
        </div>
        
        <div id="page-plan" class="page-container active">
            
            <div class="sticky-header">
                <div class="day-tabs-container no-scrollbar" id="dayTabs"></div>
                <div class="text-center text-[10px] text-white/50 pb-1 cursor-pointer" onclick="window.scrollTo(0,0)">
                    <i class="fa-solid fa-caret-up"></i> é»æ“Šå¤©æ•¸åˆ‡æ›
                </div>
            </div>

            <div class="px-4 mt-4">
                <div id="day-content" class="min-h-[50vh] pb-6"></div>

                <div class="mb-6 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg text-muji-accent"><i class="fa-solid fa-images"></i> æ—…é€”ç›¸ç°¿</h3>
                        <label class="text-xs bg-gray-200 px-3 py-1 rounded-full cursor-pointer hover:bg-gray-300">
                            + æ–°å¢ç…§ç‰‡
                            <input type="file" accept="image/*" multiple class="hidden" onchange="handleAddDayPhotos(this)">
                        </label>
                    </div>
                    <div id="day-gallery-grid" class="grid grid-cols-3 gap-2"></div>
                    <p class="text-[10px] text-gray-400 mt-2 text-center">ç…§ç‰‡å„²å­˜æ–¼æ‰‹æ©Ÿç€è¦½å™¨ä¸­</p>
                </div>

                <div class="flex justify-between mb-8 pt-4 border-t border-gray-200">
                    <button onclick="changeDayOffset(-1)" id="btnPrev" class="text-muji-secondary px-4 py-3 bg-white border border-gray-200 rounded-lg shadow-sm disabled:opacity-30 flex items-center transition-transform active:scale-95">
                        <i class="fa-solid fa-chevron-left mr-2"></i> ä¸Šä¸€å¤©
                    </button>
                    <button onclick="changeDayOffset(1)" id="btnNext" class="text-white px-4 py-3 bg-muji-accent rounded-lg shadow-sm font-bold disabled:opacity-30 flex items-center transition-transform active:scale-95">
                        ä¸‹ä¸€å¤© <i class="fa-solid fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="page-food" class="page-container pt-0">
             <div class="sticky top-0 bg-muji-bg z-30 pt-4 px-4 pb-2 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-bold text-muji-text">Food Guide</h2>
                    <span class="text-xs text-gray-400">é»æ“Šåˆ‡æ›</span>
                </div>
                <div id="food-day-tabs" class="flex overflow-x-auto gap-2 pb-2 no-scrollbar"></div>
            </div>

            <div id="food-list" class="space-y-4 px-4 mt-2"></div>
        </div>

        <div id="page-wallet" class="page-container px-4 pt-4">
            <h2 class="text-2xl font-bold mb-4 text-muji-text">Wallet</h2>
            <div class="muji-card p-4 mb-4 bg-white sticky top-0 z-30 shadow-md">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold text-muji-secondary">åŒ¯ç‡æ›ç®— (1 JPY = <span id="displayRate">0.22</span> TWD)</span>
                    <i class="fa-solid fa-gear text-gray-300 cursor-pointer" onclick="toggleRateEdit()"></i>
                </div>
                <div id="rateEditor" class="hidden mb-2">
                    <input type="number" id="customRate" step="0.001" class="muji-input h-8 text-sm" placeholder="è¨­å®šåŒ¯ç‡" onchange="updateRate()">
                </div>
                <div class="flex items-center space-x-2">
                    <div class="relative w-full">
                        <span class="absolute left-3 top-2.5 text-gray-400">Â¥</span>
                        <input type="text" id="calcInput" class="muji-input pl-8 text-lg font-mono font-bold" placeholder="500+200">
                    </div>
                    <div class="text-2xl font-bold text-muji-accent">=</div>
                    <div class="text-right min-w-[80px]">
                        <div class="text-xs text-gray-400">NT$</div>
                        <div class="text-xl font-bold" id="twdResult">0</div>
                    </div>
                </div>
            </div>
            <div class="muji-card p-4 mb-6">
                <h3 class="text-sm font-bold mb-3 text-muji-accent">æ–°å¢è¨˜å¸³</h3>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input type="text" id="expenseItem" class="muji-input col-span-2" placeholder="å“é …åç¨±">
                    <input type="number" id="expensePrice" class="muji-input" placeholder="Â¥é‡‘é¡">
                </div>
                <div class="flex justify-between items-center">
                    <label class="flex items-center space-x-2 cursor-pointer bg-gray-100 px-3 py-2 rounded-lg text-sm">
                        <i class="fa-solid fa-camera text-muji-secondary"></i>
                        <input type="file" id="expenseImg" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
                    </label>
                    <div id="imgPreviewArea" class="hidden w-8 h-8 rounded bg-cover bg-center border border-gray-300"></div>
                    <button onclick="addExpense()" class="muji-btn text-sm px-6">å„²å­˜</button>
                </div>
            </div>
            <div id="expenseList" class="space-y-3 pb-10"></div>
        </div>

        <div id="page-lists" class="page-container px-4 pt-4">
             <div class="flex space-x-2 mb-4 overflow-x-auto pb-2" id="listTabs">
                <button onclick="switchListTab('packing')" class="list-tab-btn active px-4 py-2 rounded-full text-sm font-bold border border-muji-accent bg-muji-accent text-white">å¿…å‚™æ¸…å–®</button>
                <button onclick="switchListTab('memo')" class="list-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500">å‚™å¿˜éŒ„</button>
                <button onclick="switchListTab('shop')" class="list-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500">è³¼è²·æ¸…å–®</button>
            </div>
            <div id="list-packing" class="list-content"></div>
            <div id="list-memo" class="list-content hidden">
                <textarea id="memoInput" class="muji-input h-32 mb-2" placeholder="è¼¸å…¥å‚™å¿˜äº‹é …..."></textarea>
                <button onclick="saveMemo()" class="muji-btn w-full mb-4">æ–°å¢</button>
                <div id="memoContainer" class="space-y-3"></div>
            </div>
            <div id="list-shop" class="list-content hidden">
                <div class="flex space-x-2 mb-2">
                    <input type="text" id="shopInput" class="muji-input" placeholder="æƒ³è²·ä»€éº¼? è¼¸å…¥ç¶²å€æœƒè‡ªå‹•è®Šæˆé€£çµå¡ç‰‡">
                    <button onclick="addShopItem()" class="muji-btn whitespace-nowrap">æ–°å¢</button>
                </div>
                 <div id="shopContainer" class="space-y-3"></div>
            </div>
        </div>

        <div id="page-info" class="page-container px-4 pt-4">
            <h2 class="text-2xl font-bold mb-4 text-muji-text">Info & Docs</h2>
            <div class="space-y-4">
                <div class="muji-card p-4">
                    <h3 class="font-bold mb-2 flex items-center"><i class="fa-solid fa-qrcode mr-2 text-muji-accent"></i> å…¥å¢ƒ QR Code</h3>
                    <div class="grid grid-cols-2 gap-4" id="qrContainer"></div>
                    <label class="mt-3 block text-center border-2 border-dashed border-gray-300 rounded-lg p-2 cursor-pointer hover:bg-gray-50">
                        <span class="text-xs text-gray-500">+ ä¸Šå‚³æˆªåœ–</span>
                        <input type="file" accept="image/*" class="hidden" onchange="addQRCode(this)">
                    </label>
                </div>
                <div class="muji-card p-4 border-l-4 border-red-500">
                    <h3 class="font-bold text-red-600 mb-2">ç·Šæ€¥è¯çµ¡</h3>
                    <ul class="text-sm space-y-2">
                        <li>ğŸ‘® è­¦å¯Ÿ: 110 / ğŸš‘ æ•‘è­·: 119</li>
                        <li>ğŸ‡¹ğŸ‡¼ é§æ—¥ä»£è¡¨è™• (æ±äº¬): +81-3-3280-7811</li>
                    </ul>
                </div>
                <div class="muji-card">
                    <button class="w-full text-left p-4 font-bold flex justify-between items-center" onclick="toggleAccordion('hotelInfo')">
                        <span>ğŸ¨ ä½å®¿è³‡è¨Š</span>
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                    <div id="hotelInfo" class="hidden px-4 pb-4 text-sm space-y-4 border-t border-gray-100 pt-2"></div>
                </div>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 flex justify-around items-center py-2 z-50 pb-safe">
            <button onclick="navTo('plan')" class="nav-btn active flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-regular fa-calendar-days text-xl mb-1"></i><span class="text-[10px]">è¡Œç¨‹</span>
            </button>
            <button onclick="navTo('food')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-utensils text-xl mb-1"></i><span class="text-[10px]">é£Ÿè¨˜</span>
            </button>
            <button onclick="navTo('wallet')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px]">è¨˜å¸³</span>
            </button>
            <button onclick="navTo('lists')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-list-check text-xl mb-1"></i><span class="text-[10px]">æ¸…å–®</span>
            </button>
            <button onclick="navTo('info')" class="nav-btn flex flex-col items-center p-2 text-muji-secondary w-full">
                <i class="fa-solid fa-circle-info text-xl mb-1"></i><span class="text-[10px]">è³‡è¨Š</span>
            </button>
        </nav>

    </div>

    <script>
        // --- FULL ITINERARY (11 DAYS) with MERGED EVENTS ---
        const itinerary = [
            { day: 1, date: "2/24 (äºŒ)", title: "æŠµé” & ç§»å‹•è¼•äº•æ¾¤", icon: "fa-plane", weather: { text: "æ±äº¬ æ™´ 5~11Â°C", icon: "fa-sun", link: "Tokyo" }, events: [{ time: "06:40", title: "é…·èˆª TR898 å‡ºç™¼", note: "ç¬¬ä¸€èˆªå»ˆ", type: "flight" }, { time: "10:45", title: "æŠµé”æˆç”°æ©Ÿå ´", type: "flight" }, { time: "11:13~", title: "æ­è»Šå‰å¾€ä¸Šé‡", note: "è»Šç¨‹50åˆ†", type: "train" }, { time: "12:00", title: "ä¸Šé‡åˆé¤", type: "food" }, { time: "15:10", title: "æ–°å¹¹ç·š -> è¼•äº•æ¾¤", note: "ä¸Šé‡å‡ºç™¼", type: "train", highlight: true }, { time: "16:30", title: "ç§Ÿé›ªå…·", address: "4-8 KARUIZAWAHIGASHI", type: "activity" }, { time: "18:00", title: "æ™šé¤", type: "food" }] },
            { day: 2, date: "2/25 (ä¸‰)", title: "æ»‘é›ªæ—¥", icon: "fa-person-skiing", weather: { text: "è¼•äº•æ¾¤ é›ª -2~3Â°C", icon: "fa-snowflake", link: "Nagano/Karuizawa" }, events: [{ time: "All Day", title: "æ»‘é›ª", note: "è¼•äº•æ¾¤æ»‘é›ªå ´", type: "activity" }] },
            { day: 3, date: "2/26 (å››)", title: "æ»‘é›ª & ç§Ÿè»Š", icon: "fa-person-skiing", weather: { text: "è¼•äº•æ¾¤ é›ª -3~2Â°C", icon: "fa-snowflake", link: "Nagano/Karuizawa" }, events: [{ time: "09:00", title: "æ»‘é›ª", note: "è‡³ 16:00", type: "activity" }, { time: "17:00", title: "ç§Ÿè»Š", type: "car", highlight: true }] },
            { day: 4, date: "2/27 (äº”)", title: "è¼•äº•æ¾¤è§€å…‰ & å›æ±äº¬", icon: "fa-camera", weather: { text: "è¼•äº•æ¾¤ é™° 0~5Â°C", icon: "fa-cloud", link: "Nagano/Karuizawa" }, events: [{ time: "09:30", title: "æ¦†æ¨¹è¡—å°é®", type: "sight" }, { time: "11:00", title: "é›²å ´æ± ", type: "sight" }, { time: "13:57", title: "æ–°å¹¹ç·šå›ä¸Šé‡", type: "train", highlight: true }, { time: "18:00", title: "ä¸Šé‡æ™šé¤", type: "food" }] },
            { 
                day: 5, date: "2/28 (å…­)", title: "æ±äº¬é€›è¡— -> å±±å½¢æ–°åº„", icon: "fa-train", weather: { text: "æ±äº¬ æ™´ 6~12Â°C", icon: "fa-sun", link: "Tokyo" }, 
                events: [
                    { time: "09:30", title: "å¦™ç¾©ç¥ç¤¾", address: "3 Chome-16-16 Komagome", type: "sight" }, 
                    { time: "10:30", title: "æ± è¢‹å¤ªé™½åŸ", type: "shop" },
                    // æ’å…¥é˜¿ç‹é˜¿çœŸå›ç¨‹
                    { time: "14:20", title: "é˜¿ç‹é˜¿çœŸå‰å¾€æ©Ÿå ´", note: "æ­ Skyliner -> æˆç”° (CI105 17:45èµ·é£›)", type: "train", highlight: true, customColor: "text-muji-leave border-muji-leave" },
                    { time: "14:00", title: "æœ¬éšŠ: æ–°å¹¹ç·š -> æ–°åº„", type: "train", highlight: true }
                ] 
            },
            { day: 6, date: "3/1 (æ—¥)", title: "æœ€ä¸Šå·éŠèˆ¹ -> ä»™å°", icon: "fa-ship", weather: { text: "å±±å½¢ é™°é›¨ 2~7Â°C", icon: "fa-cloud-rain", link: "Yamagata" }, events: [{ time: "08:10", title: "JRé™¸ç¾½è¥¿ç·š -> å¤å£", note: "08:50æŠµé”", type: "train" }, { time: "09:00", title: "æœ€ä¸Šå·éŠèˆ¹", type: "activity", highlight: true }, { type: "html", content: `<div class="mt-2 text-sm bg-white p-3 rounded-lg border border-gray-200"><h4 class="font-bold text-muji-accent mb-2"><i class="fa-solid fa-train"></i> ç§»å‹•æ™‚åˆ»è¡¨</h4><div class="mb-3"><span class="font-bold text-gray-600 border-b-2 border-gray-200">Local: å¤å£/é«˜å±‹ â®• æ–°åº„</span><table class="schedule-table"><tr><th>è·¯ç·š</th><th>å‡ºç™¼</th><th>æŠµé”</th></tr><tr><td>é«˜å±‹â®•æ–°åº„</td><td>12:05</td><td>12:54</td></tr><tr><td>å¤å£â®•æ–°åº„</td><td>12:18</td><td>12:54</td></tr><tr><td>å¤å£â®•æ–°åº„</td><td>13:39</td><td>14:05</td></tr></table></div><div class="mb-3"><span class="tag-a mb-1 inline-block">PLAN A</span> <span class="text-xs font-bold text-muji-planA">æ–°å¹¹ç·š (è½‰ç¦å³¶)</span><table class="schedule-table"><tr><th>å€é–“</th><th>ç­æ¬¡ 1</th><th>ç­æ¬¡ 2</th></tr><tr><td>æ–°åº„â®•ç¦å³¶</td><td>13:18 - 15:14</td><td>15:17 - 17:14</td></tr><tr><td>ç¦å³¶â®•ä»™å°</td><td>15:37 - 17:24</td><td>16:05 - 17:46</td></tr></table></div><div><span class="tag-b mb-1 inline-block">PLAN B</span> <span class="text-xs font-bold text-muji-planB">å¥§ç¾½æœ¬ç·š + å·´å£«</span><table class="schedule-table"><tr><th>å€é–“</th><th>æ™‚é–“</th></tr><tr><td>æ–°åº„â®•å±±å½¢</td><td>14:19-15:32 / 16:14-17:23</td></tr><tr><td>å±±å½¢â®•ä»™å°</td><td>é«˜é€Ÿå·´å£« (æ¯30åˆ†ä¸€ç­)</td></tr><tr><td>JRä»™å±±ç·š</td><td>å±±å½¢18:02 - ä»™å°19:32</td></tr></table></div></div>` }, { time: "19:40", title: "Check in & æ™šé¤", type: "hotel" }] },
            { day: 7, date: "3/2 (ä¸€)", title: "åˆ†æµ: å±±å¯º vs è‰è“", icon: "fa-arrows-split-up-and-left", weather: { text: "ä»™å°/å±±å¯º å¤šé›² 4~9Â°C", icon: "fa-cloud-sun", link: "Miyagi/Sendai" }, events: [{ type: "html", content: `<div class="space-y-4"><div class="bg-white rounded-lg border-l-4 border-muji-planA shadow-sm overflow-hidden"><div class="bg-slate-50 p-2 font-bold text-muji-planA"><span><i class="fa-solid fa-person-hiking"></i> PLAN A: å±±å¯º</span></div><div class="p-3 space-y-3"><div class="flex justify-between items-start"><div><div class="text-sm font-bold">å‡ºç™¼ (JRä»™å±±ç·š)</div><div class="text-xs text-gray-500">8:18 æˆ– 9:12 ä»™å°ç™¼</div></div><button onclick="openMap('Yamadera, Yamagata')" class="text-muji-accent text-sm"><i class="fa-solid fa-location-dot"></i></button></div><div class="flex justify-between items-start pt-2 border-t border-gray-100"><div><div class="text-sm font-bold">13:00 åˆé¤: ç„°è—</div></div><button onclick="openMap('Yamagata Soba no Enzou Yamadera')" class="text-muji-accent text-sm"><i class="fa-solid fa-utensils"></i></button></div></div></div><div class="bg-white rounded-lg border-l-4 border-muji-planB shadow-sm overflow-hidden"><div class="bg-orange-50 p-2 font-bold text-muji-planB"><span><i class="fa-solid fa-car-side"></i> PLAN B: è‡ªé§•</span></div><div class="p-3 space-y-3"><div class="flex justify-between items-start"><div><div class="text-xs font-bold text-gray-400">08:30</div><div class="text-sm font-bold">ä»™å°æœå¸‚</div></div><button onclick="openMap('Sendai Morning Market')" class="text-muji-accent text-sm"><i class="fa-solid fa-location-dot"></i></button></div><div class="flex justify-between items-start pt-2 border-t border-gray-100"><div><div class="text-xs font-bold text-gray-400">10:00</div><div class="text-sm font-bold">æ¡è‰è“: ä¸€è‹ºä¸€ç¬‘</div></div><button onclick="openMap('Ichigo Ichie Matsumori Farm')" class="text-muji-accent text-sm"><i class="fa-solid fa-location-dot"></i></button></div><div class="flex justify-between items-start pt-2 border-t border-gray-100"><div><div class="text-xs font-bold text-gray-400">13:00</div><div class="text-sm font-bold">Costco å¯Œè°·å€‰åº«åº—</div></div><button onclick="openMap('Costco Tomiya')" class="text-muji-accent text-sm"><i class="fa-solid fa-cart-shopping"></i></button></div></div></div></div>` }] },
            { 
                day: 8, date: "3/3 (äºŒ)", title: "ä»™å°å¸‚å€ & å®¶æ—æœƒåˆ", icon: "fa-handshake", weather: { text: "ä»™å° æ™´ 5~10Â°C", icon: "fa-sun", link: "Miyagi/Sendai" }, 
                events: [
                    { time: "09:30", title: "ç‘é³³æ®¿", type: "sight" }, 
                    { time: "11:00", title: "å¤§å´å…«å¹¡å®®", type: "sight" }, 
                    { time: "15:00", title: "ç§Ÿè»Š", type: "car", highlight: true },
                    // æ’å…¥å®¶æ—æœƒåˆ
                    { time: "16:00", title: "å®¶æ—æŠµé”ä»™å°æ©Ÿå ´", note: "æ˜Ÿå®‡ JX862", type: "flight", customColor: "text-muji-join border-muji-join" },
                    { time: "17:30", title: "ä»™å°è»Šç«™å¤§æœƒåˆ", note: "æ¥äºº", type: "activity", highlight: true },
                    { time: "18:30", title: "æ™šé¤: è‚‰åå…«", type: "food" }
                ] 
            },
            { day: 9, date: "3/4 (ä¸‰)", title: "ç‹ç‹¸æ‘ & è—ç‹æ¨¹å†°", icon: "fa-snowflake", weather: { text: "è—ç‹ é›ª -4~1Â°C", icon: "fa-snowflake", link: "Miyagi/Shiroishi" }, events: [{ time: "09:00", title: "é‡‘ç¥æ°´ç¥ç¤¾", type: "sight" }, { time: "10:30", title: "è—ç‹ç‹ç‹¸æ‘", address: "Miyagi, Shiroishi", type: "activity", highlight: true }, { time: "12:40", title: "é åˆˆç”°æº«æ³‰", type: "sight" }, { time: "15:15", title: "è—ç‹æ¨¹å†°", address: "Zaoonsen, Yamagata", type: "sight", highlight: true }, { time: "17:30", title: "Check-in å±±å½¢", type: "hotel" }, { time: "18:00", title: "æ™šé¤", type: "food" }] },
            { day: 10, date: "3/5 (å››)", title: "éŠ€å±±æº«æ³‰ & æ¾å³¶", icon: "fa-spa", weather: { text: "å±±å½¢/æ¾å³¶ é™° 3~8Â°C", icon: "fa-cloud", link: "Yamagata" }, events: [{ time: "09:10", title: "é“ã®é§… å¤©ç«¥æ¸©æ³‰", type: "shop" }, { time: "10:40", title: "éŠ€å±±æº«æ³‰æ¥é§", note: "å¤§æ­£æµªæ¼«é¤¨æ­è»Š", type: "bus", highlight: true }, { time: "16:00", title: "æ¾å³¶æµ·å²¸", type: "sight" }, { time: "18:00", title: "ä¸‰äº• OUTLET ä»™å°æ¸¯", type: "shop" }] },
            { day: 11, date: "3/6 (äº”)", title: "å›ç¨‹", icon: "fa-plane-departure", weather: { text: "ä»™å°/å°ç£ æ™´", icon: "fa-sun", link: "Miyagi/Sendai" }, events: [{ time: "11:30", title: "AEON MALL", type: "shop" }, { time: "14:47", title: "å‰å¾€ä»™å°æ©Ÿå ´", type: "train" }, { time: "17:25", title: "æ˜Ÿå®‡ JX863 èµ·é£›", note: "20:35 æŠµé”å°ç£", type: "flight", highlight: true }] }
        ];

        // --- Data ---
        const hotels = [
            { name: "è¼•äº•æ¾¤ç‹å­é£¯åº—è¥¿é¤¨", date: "2/24-2/27", address: "389-0193 é•·é‡ç¸£åŒ—ä½ä¹…éƒ¡è¼•äº•æ¾¤ç”ºè¼•äº•æ¾¤1016-85", tel: "+81-(0)267-42-1113" },
            { name: "LANDABOUT TOKYO", date: "2/27-2/28", address: "æ±äº¬éƒ½, æ±äº¬, Taito-ku Negishi 3-4-5", tel: "+81-3-6802-4437" },
            { name: "Route Inn æ–°èŠç«™å‰", date: "2/28-3/1", address: "å±±å½¢çœŒæ–°åº„å¸‚é‡‘æ²¢æ²–1109-6", tel: "050-1809-5168" },
            { name: "The OneFive Sendai", date: "3/1-3/4", address: "4 Chome-6-28 Tsutsujigaoka, Miyagino Ward, Sendai, Miyagi 983-0852", tel: "" },
            { name: "Route Inn Yamagataminami", date: "3/4", address: "1 Chome-1-11 Iidanishi, Yamagata, 990-2331", tel: "" },
            { name: "The OneFive Sendai", date: "3/5", address: "4 Chome-6-28 Tsutsujigaoka, Miyagino Ward, Sendai, Miyagi 983-0852", tel: "" },
        ];
        const packingList = {
            "å€‹äººç‰©å“": ["è­·ç…§", "ä¿¡ç”¨å¡", "èº«åˆ†è­‰", "ç¾é‡‘", "èº«åˆ†è­‰å½±æœ¬", "è­·ç…§å½±æœ¬", "é§•ç…§", "åœ‹éš›é§•ç…§", "é§•ç…§è­¯æœ¬"],
            "é›œç‰©": ["è¡£ç‰©", "å¸½å­", "å¤ªé™½çœ¼é¡", "éš±çœ¼", "æ¢³å­", "ä¿é¤Šå“", "è—¥å“"],
            "é›»å­ç”¢å“": ["å……é›»å™¨", "å……é›»ç·š", "è¡Œå‹•é›»æº", "è¬åœ‹æ’åº§", "GoPro", "é›»æ± /è¨˜æ†¶å¡", "ç¶²å¡"],
            "æ»‘é›ªæº–å‚™": ["é›ªé¡", "æ’æ±—è¡£", "ä¿æš–é•·è¢–", "æ‰‹å¥—", "é•·è¥ª", "é˜²æ»‘é‹", "å±å¢Š", "æš–æš–åŒ…", "è­·è†", "è­·æ‰‹", "å†°çˆª"]
        };
        
        // --- Updated Food Data ---
        const foodData = [
             {
                day: "Day 1: ä¸Šé‡åˆé¤ Ueno Lunch",
                spots: [
                    { name: "èŸ¹é£Ÿæ”¾é¡Œ ã”ã£ã¤ãŠ", type: "åˆé¤", address: "https://maps.app.goo.gl/Rp6dMS3VGsW6yh9K8", note: "èƒèŸ¹åƒåˆ°é£½" },
                    { name: "æ±äº¬ç‚¸è±¬æ’ ãŒã¶ã†", type: "åˆé¤", address: "https://maps.app.goo.gl/pg8YiKhQ7DvFyB6p9", note: "é»‘æ¯›å’Œç‰›ç‚¸è‚‰é¤…" },
                    { name: "å¤©å©¦ç¾… å¤©å¯¿ã‚", type: "åˆé¤", address: "https://maps.app.goo.gl/1UPZHjPUsC9de1UQA", note: "å‰µæ¥­è€èˆ–" },
                    { name: "é‡‘æ²¢ã¾ã„ã‚‚ã‚“å¯¿å¸", type: "åˆé¤", address: "https://maps.app.goo.gl/VPMDuMSszPCgQpFV6", note: "ä¾†è‡ªé‡‘æ¾¤çš„ç¾å‘³" }
                ]
            },
            {
                day: "Day 1-3: è¼•äº•æ¾¤ Karuizawa",
                spots: [
                    { name: "ã—ã‚ƒã¶ã—ã‚ƒã¶æ„›å®•", type: "æ™šé¤", address: "https://maps.app.goo.gl/uGzDhdyx7qHgRKyy5", tel: "0267-41-6111", note: "æ¶®æ¶®é‹" },
                    { name: "ã‚¢ã‚¯ã‚»ã‚¹ (ACCESS)", type: "æ™šé¤", address: "https://maps.app.goo.gl/sYZRLBTJ7d3M66Wd6", tel: "0267-42-3081", note: "" },
                    { name: "æ‘æ°‘é£Ÿå ‚", type: "æ™šé¤", address: "https://maps.app.goo.gl/kaefExA2mjnSSkpd8", tel: "0267-44-3571", note: "æ˜Ÿé‡å€æ—¥å¼å®šé£Ÿ" },
                    { name: "ã‚ãäº­ (Log-tei)", type: "æ™šé¤", address: "https://maps.app.goo.gl/qbN35Ey3FKH4e9YW9", tel: "0267-45-2341", note: "ç‡’è‚‰ / ç‰›æ’" },
                    { name: "Fujiya", type: "æ™šé¤", address: "https://maps.app.goo.gl/e3EARNFtAoGALaid9", note: "æ´‹é£Ÿ / éºµåŒ…" },
                    { name: "Primo Fito", type: "æ™šé¤", address: "https://maps.app.goo.gl/C4WtRCwJ9JHAnzLr5", note: "ç¾©å¼æ–™ç†" }
                ]
            },
            {
                day: "Day 4: æ±äº¬ä¸Šé‡ Ueno",
                spots: [
                    { name: "ä¸‰æµ¦ä¸‰å´æ¸¯ è¿´è½‰å£½å¸", type: "æ™šé¤", address: "https://maps.app.goo.gl/VJXgERqoWoxW7uAa9", note: "é£Ÿæå †å¾—åƒå±±ä¸€æ¨£" },
                    { name: "ã½ã‚“å¤šæœ¬å®¶", type: "æ™šé¤", address: "https://maps.app.goo.gl/4W1kfAtLvaYV6bqeA", note: "ç‚¸è±¬æ’è€èˆ–" },
                    { name: "ä¸Šé‡å…”å±‹ (Usagiya)", type: "ç”œé»", address: "https://maps.app.goo.gl/3wWrCgXUDpZkRApn6", note: "éŠ…é‘¼ç‡’ååº—" },
                    { name: "EGG BABY CAFÃ‰", type: "è¼•é£Ÿ", address: "https://maps.app.goo.gl/YGDFKHrPwm7JcBGu6", note: "åŠç†Ÿè›‹ä¸‰æ˜æ²»" },
                    { name: "é³¥æµ ä¸Šé‡åºƒå°è·¯åº—", type: "æ™šé¤", address: "https://maps.app.goo.gl/DGbWb1ibo8DTaD6J7", note: "ç‡’é³¥ (ä¸²ç‡’)" }
                ]
            },
             {
                day: "Day 5: å±±å½¢æ–°åº„ Shinjo",
                spots: [
                     { name: "å‘³åœ’ (Aji-en)", type: "æ™šé¤", address: "https://maps.app.goo.gl/XSJPdcdrTYY7gKBY8", note: "ç‡’è‚‰ / é£Ÿå ‚" },
                     { name: "CLAN", type: "æ™šé¤", address: "https://maps.app.goo.gl/QQQUaDzkm2DiJMEF7", tel: "+81233321718", note: "Dining Bar" },
                     { name: "Tea Room Pinocchio", type: "æ™šé¤", address: "https://maps.app.goo.gl/nPSk2qRxAr8RpphK6", tel: "+81233234551", note: "å–«èŒ¶åº— / æ´‹é£Ÿ" },
                     { name: "æ–°æ—¬å±‹ æœ¬åº—", type: "æ™šé¤", address: "https://maps.app.goo.gl/6YV5b7cRjwYs5NXv7", tel: "+81233234634", note: "é‡‘é›æ‹‰éºµ (16:30-20:30)" }
                ]
            },
            {
                day: "Day 7: å±±å¯º Yamadera",
                spots: [
                    { name: "ç„°è— (å±±å¯ºåº—)", type: "åˆé¤", address: "https://maps.app.goo.gl/GRtQ5nHR4hgQHRYx8", note: "å±±å½¢è•éº¥éºµ" }
                ]
            },
            {
                day: "Day 8: ä»™å° Sendai",
                spots: [
                    { name: "è‚‰åå…«", type: "æ™šé¤", address: "https://maps.app.goo.gl/Ej3BFShnWRhJDVdo6", note: "ç‡’è‚‰åƒåˆ°é£½" }
                ]
            },
            {
                day: "Day 9: å±±å½¢å¸‚å€ Yamagata",
                spots: [
                    { name: "é…’èœä¸€", type: "æ™šé¤", address: "https://maps.app.goo.gl/g6U6oPuYYoBGwnFH7", tel: "+815054841844", note: "å±…é…’å±‹ / é„‰åœŸæ–™ç†" },
                    { name: "å±±å½¢è‚‰å•å±‹ã‚»ãƒ³ã‚¿ãƒ¼", type: "æ™šé¤", address: "https://maps.app.goo.gl/fj9Dnprd52xy6EVK7", tel: "+817011455641", note: "ç‡’è‚‰ / è‚‰æ–™ç†" },
                    { name: "Suzuran (ã™ãšã‚‰ã‚“)", type: "æ™šé¤", address: "https://maps.app.goo.gl/xeKVC9QcoSyXpR628", tel: "+81236422911", note: "æ‹‰éºµ / ä¸­è¯æ–™ç†" },
                    { name: "ISLAND PEAK", type: "é…’å§", address: "https://maps.app.goo.gl/2AzN5zdezWWHFFJq8", tel: "+81236767885", note: "International CafÃ© & Bar" }
                ]
            }
        ];

        // --- Core Logic ---
        let currentDayIndex = 0;
        let dayPhotos = JSON.parse(localStorage.getItem('trip_day_photos')) || {};

        document.addEventListener('DOMContentLoaded', () => {
            renderDayTabs();
            jumpToDay(0);
            initFood();
            initWallet();
            initLists();
            initInfo();
            loadCover();
            updateGlobalWeather();
        });

        function updateGlobalWeather() {
            const d = new Date();
            const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
            document.getElementById('globalWeather').innerHTML = `${dateStr} æ±äº¬ â›… 8Â°C`;
        }

        // --- NAVIGATION ---
        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = itinerary.map((day, idx) => `
                <div onclick="jumpToDay(${idx})" class="day-tab ${idx === 0 ? 'active' : ''}" id="tab-${idx}">
                    D${day.day}
                </div>
            `).join('');
        }

        function jumpToDay(index) {
            index = parseInt(index, 10);
            if (isNaN(index) || index < 0) index = 0;
            if (index >= itinerary.length) index = itinerary.length - 1;
            
            currentDayIndex = index;
            renderDay(index);
            window.scrollTo(0, 0);
        }

        function changeDayOffset(offset) {
            jumpToDay(currentDayIndex + offset);
        }

        function renderDay(index) {
            const day = itinerary[index];
            const container = document.getElementById('day-content');

            // Tabs Styling
            document.querySelectorAll('.day-tab').forEach((el, idx) => {
                if(idx === index) {
                    el.classList.add('active');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    el.classList.remove('active');
                }
            });

            // Buttons
            document.getElementById('btnPrev').disabled = (index === 0);
            document.getElementById('btnPrev').style.opacity = (index === 0) ? '0.3' : '1';
            document.getElementById('btnNext').disabled = (index === itinerary.length - 1);
            document.getElementById('btnNext').style.opacity = (index === itinerary.length - 1) ? '0.3' : '1';

            // Events
            let eventsHtml = '';
            day.events.forEach(evt => {
                if (evt.type === 'html') {
                    eventsHtml += `<div class="relative pl-8 pb-4"><div class="timeline-dot absolute left-[22px] top-1"></div>${evt.content}</div>`;
                } else {
                    // Check for custom colors
                    let borderClass = evt.highlight ? 'border-l-4 border-muji-highlight pl-2' : '';
                    let textClass = evt.highlight ? 'text-muji-highlight font-bold' : '';
                    
                    if(evt.customColor) {
                        const colors = evt.customColor.split(' ');
                        const textC = colors.find(c => c.startsWith('text-')) || '';
                        const borderC = colors.find(c => c.startsWith('border-')) || '';
                        textClass = `${textC} font-bold`;
                        borderClass = `border-l-4 ${borderC} pl-2`;
                    }

                    const mapBtn = evt.address ? `<button onclick="openMap('${evt.address}')" class="ml-2 text-muji-accent"><i class="fa-solid fa-location-dot"></i></button>` : '';
                    eventsHtml += `
                        <div class="relative pl-8 pb-6 last:pb-0">
                            <div class="timeline-dot absolute left-[22px] top-1"></div>
                            <div class="text-sm font-bold text-muji-accent">${evt.time}</div>
                            <div class="bg-white p-3 rounded-lg shadow-sm mt-1 border border-gray-100 ${borderClass}">
                                <div class="font-medium text-base ${textClass}">${evt.title} ${mapBtn}</div>
                                ${evt.note ? `<div class="text-xs text-gray-500 mt-1">${evt.note}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            });

            const weatherHtml = `
                <div class="weather-badge mb-2 shadow-sm border border-gray-100">
                    <i class="fa-solid ${day.weather.icon} mr-2 text-blue-500"></i> ${day.weather.text}
                    <button onclick="openWeather('${day.weather.link}')" class="ml-2 text-gray-400 hover:text-blue-600 border-l pl-2 border-gray-300"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
                </div>
            `;

            container.innerHTML = `
                <div class="animate-fade-in">
                    <div class="relative mb-8">
                        <div class="timeline-line"></div>
                        <div class="mb-4 bg-muji-bg z-20 pt-2">
                            <div class="flex justify-between items-end">
                                <h3 class="font-bold text-2xl text-muji-text">${day.date}</h3>
                                ${weatherHtml}
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-2 mb-1">
                                <i class="fa-solid ${day.icon}"></i> ${day.title}
                            </div>
                        </div>
                        <div class="mt-2">
                            ${eventsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            renderDayPhotos(index);
            container.animate([{ opacity: 0, transform: 'translateY(5px)' }, { opacity: 1, transform: 'translateY(0)' }], { duration: 250, easing: 'ease-out' });
        }

        // --- DAY PHOTO LOGIC ---
        function handleAddDayPhotos(input) {
            if (input.files) {
                const files = Array.from(input.files);
                const dayIdx = currentDayIndex.toString();
                if(!dayPhotos[dayIdx]) dayPhotos[dayIdx] = [];

                let processedCount = 0;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_WIDTH = 300;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                            dayPhotos[dayIdx].push(dataUrl);
                            processedCount++;
                            if(processedCount === files.length) {
                                localStorage.setItem('trip_day_photos', JSON.stringify(dayPhotos));
                                renderDayPhotos(currentDayIndex);
                            }
                        }
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        function renderDayPhotos(idx) {
            const container = document.getElementById('day-gallery-grid');
            const photos = dayPhotos[idx.toString()] || [];
            if(photos.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center text-gray-300 text-sm py-4">å°šç„¡ç…§ç‰‡</div>';
                return;
            }
            container.innerHTML = photos.map((src, photoIdx) => `
                <div class="relative group aspect-square">
                    <div class="w-full h-full bg-cover bg-center rounded-lg border border-gray-100 shadow-sm" style="background-image: url(${src})" onclick="showFullImg('${src}')"></div>
                    <button onclick="deleteDayPhoto(${idx}, ${photoIdx})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center opacity-80 shadow"><i class="fa-solid fa-xmark"></i></button>
                </div>
            `).join('');
        }

        function deleteDayPhoto(dayIdx, photoIdx) {
            if(confirm('åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ')) {
                dayPhotos[dayIdx].splice(photoIdx, 1);
                localStorage.setItem('trip_day_photos', JSON.stringify(dayPhotos));
                renderDayPhotos(dayIdx);
            }
        }

        // --- Helpers ---
        function navTo(pageId) {
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => { el.classList.remove('text-muji-accent'); el.classList.add('text-muji-secondary'); });
            event.currentTarget.classList.remove('text-muji-secondary'); event.currentTarget.classList.add('text-muji-accent');
            window.scrollTo(0,0);
        }
        function openMap(address) { 
            if(!address) return; 
            if(address.startsWith('http')) {
                window.open(address, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(address)}`, '_blank'); 
            }
        }
        function openWeather(loc) { window.open(`https://www.google.com/search?q=weather+${loc}+japan`, '_blank'); }
        
        // --- COVER & ICON LOGIC ---
        function loadCover() { 
            const s = localStorage.getItem('trip_cover'); 
            if(s) {
                document.getElementById('cover-area').style.backgroundImage = `url(${s})`;
                document.getElementById('appIcon').href = s;
                document.getElementById('favIcon').href = s;
            }
        }
        function changeCover(input) { 
            if (input.files && input.files[0]) { 
                const r = new FileReader(); 
                r.onload = function (e) { 
                    const img = new Image(); 
                    img.src = e.target.result; 
                    img.onload = function() { 
                        const c = document.createElement('canvas'); 
                        const ctx = c.getContext('2d'); 
                        const s = 800/img.width; 
                        c.width = 800; 
                        c.height = img.height * s; 
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
                        const d = c.toDataURL('image/jpeg', 0.7); 
                        document.getElementById('cover-area').style.backgroundImage = `url(${d})`; 
                        document.getElementById('appIcon').href = d;
                        document.getElementById('favIcon').href = d;
                        localStorage.setItem('trip_cover', d); 
                    }
                }; 
                r.readAsDataURL(input.files[0]); 
            }
        }

        // --- Wallet Logic ---
        let rate = localStorage.getItem('trip_rate') || 0.22;
        let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
        function initWallet() { document.getElementById('displayRate').innerText = rate; document.getElementById('calcInput').addEventListener('input', calculate); renderExpenses(); }
        function toggleRateEdit() { document.getElementById('rateEditor').classList.toggle('hidden'); }
        function updateRate() { const val = parseFloat(document.getElementById('customRate').value); if(val) { rate = val; localStorage.setItem('trip_rate', rate); document.getElementById('displayRate').innerText = rate; calculate(); renderExpenses(); toggleRateEdit(); } }
        function calculate() { const input = document.getElementById('calcInput').value; try { if(input.match(/^[0-9+\-*/.() ]+$/)) { const jpy = new Function('return ' + input)(); document.getElementById('twdResult').innerText = Math.round(jpy * rate).toLocaleString(); } } catch(e) {} }
        let currentExpenseImg = null;
        function handleImagePreview(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = function (e) { const img = new Image(); img.src = e.target.result; img.onload = function() { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); const s = 400/img.width; c.width = 400; c.height = img.height * s; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); currentExpenseImg = c.toDataURL('image/jpeg', 0.6); document.getElementById('imgPreviewArea').style.backgroundImage = `url(${currentExpenseImg})`; document.getElementById('imgPreviewArea').classList.remove('hidden'); }}; r.readAsDataURL(input.files[0]); }}
        function addExpense() { const item = document.getElementById('expenseItem').value; const price = parseFloat(document.getElementById('expensePrice').value); if(!item || !price) return alert('è«‹è¼¸å…¥é …ç›®èˆ‡é‡‘é¡'); expenses.unshift({ id: Date.now(), item, price, img: currentExpenseImg, date: new Date().toLocaleDateString() }); localStorage.setItem('trip_expenses', JSON.stringify(expenses)); document.getElementById('expenseItem').value = ''; document.getElementById('expensePrice').value = ''; document.getElementById('imgPreviewArea').classList.add('hidden'); currentExpenseImg = null; renderExpenses(); }
        function deleteExpense(id) { if(confirm('ç¢ºå®šåˆªé™¤?')) { expenses = expenses.filter(e => e.id !== id); localStorage.setItem('trip_expenses', JSON.stringify(expenses)); renderExpenses(); } }
        function renderExpenses() { const list = document.getElementById('expenseList'); list.innerHTML = expenses.map(e => `<div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center border border-gray-100"><div class="flex items-center gap-3">${e.img ? `<div onclick="showFullImg('${e.img}')" class="w-10 h-10 bg-cover bg-center rounded bg-gray-200 flex-shrink-0" style="background-image:url(${e.img})"></div>` : `<div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-gray-400"><i class="fa-solid fa-yen-sign"></i></div>`}<div><div class="font-bold text-sm">${e.item}</div><div class="text-xs text-gray-400">${e.date}</div></div></div><div class="text-right"><div class="font-bold">Â¥${e.price}</div><div class="text-xs text-gray-400">NT$${Math.round(e.price * rate)}</div><button onclick="deleteExpense(${e.id})" class="text-gray-300 text-xs mt-1"><i class="fa-solid fa-trash"></i></button></div></div>`).join(''); }
        function showFullImg(src) { const w = window.open(""); w.document.write(`<img src="${src}" style="width:100%">`); }

        // --- Lists Logic ---
        let userChecklist = JSON.parse(localStorage.getItem('trip_checklist')) || {};
        let memoList = JSON.parse(localStorage.getItem('trip_memos')) || [];
        let shopList = JSON.parse(localStorage.getItem('trip_shop')) || [];
        function initLists() { renderPacking(); renderMemo(); renderShop(); }
        function switchListTab(tab) { document.querySelectorAll('.list-tab-btn').forEach(b => { b.classList.remove('bg-muji-accent', 'text-white', 'border-muji-accent'); b.classList.add('bg-white', 'text-gray-500', 'border-muji-border'); }); event.currentTarget.classList.remove('bg-white', 'text-gray-500', 'border-muji-border'); event.currentTarget.classList.add('bg-muji-accent', 'text-white', 'border-muji-accent'); document.querySelectorAll('.list-content').forEach(d => d.classList.add('hidden')); document.getElementById(`list-${tab}`).classList.remove('hidden'); }
        function renderPacking() { let html = ''; for (const [category, items] of Object.entries(packingList)) { html += `<div class="mb-4"><h3 class="font-bold text-muji-accent mb-2">${category}</h3><div class="space-y-2">` + items.map(item => `<label class="flex items-center bg-white p-3 rounded shadow-sm border border-gray-100"><input type="checkbox" class="w-5 h-5 accent-teal-700 mr-3" ${userChecklist[item] ? 'checked' : ''} onchange="toggleCheck('${item}')"><span class="${userChecklist[item] ? 'line-through text-gray-400' : ''}">${item}</span></label>`).join('') + `</div></div>`; } document.getElementById('list-packing').innerHTML = html; }
        function toggleCheck(item) { userChecklist[item] = !userChecklist[item]; localStorage.setItem('trip_checklist', JSON.stringify(userChecklist)); renderPacking(); }
        function saveMemo() { const txt = document.getElementById('memoInput').value; if(txt) { memoList.push({ id: Date.now(), text: txt }); localStorage.setItem('trip_memos', JSON.stringify(memoList)); document.getElementById('memoInput').value = ''; renderMemo(); } }
        function renderMemo() { document.getElementById('memoContainer').innerHTML = memoList.map(m => `<div class="bg-yellow-50 p-3 rounded shadow-sm border border-yellow-100 text-sm relative"><button onclick="deleteMemo(${m.id})" class="absolute top-1 right-2 text-gray-400"><i class="fa-solid fa-xmark"></i></button><div class="whitespace-pre-wrap pr-4">${m.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 underline">$1</a>')}</div></div>`).join(''); }
        function deleteMemo(id) { memoList = memoList.filter(m => m.id !== id); localStorage.setItem('trip_memos', JSON.stringify(memoList)); renderMemo(); }
        function addShopItem() { const txt = document.getElementById('shopInput').value; if(txt) { let type = 'text'; let meta = ''; const match = txt.match(/(https?:\/\/[^\s]+)/g); if(match) { type = 'link'; try { meta = new URL(match[0]).hostname; } catch(e) { meta = 'Link'; } } shopList.push({ id: Date.now(), text: txt, bought: false, type: type, meta: meta }); localStorage.setItem('trip_shop', JSON.stringify(shopList)); document.getElementById('shopInput').value = ''; renderShop(); } }
        function toggleShop(id) { const idx = shopList.findIndex(i => i.id === id); if(idx > -1) { shopList[idx].bought = !shopList[idx].bought; localStorage.setItem('trip_shop', JSON.stringify(shopList)); renderShop(); } }
        function deleteShopItem(id) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®?')) { shopList = shopList.filter(i => i.id !== id); localStorage.setItem('trip_shop', JSON.stringify(shopList)); renderShop(); } }
        function renderShop() { document.getElementById('shopContainer').innerHTML = shopList.map(item => { let content = item.type === 'link' ? `<div class="flex-1"><a href="${item.text.match(/(https?:\/\/[^\s]+)/)[0]}" target="_blank" class="block bg-gray-50 border border-gray-200 rounded p-2 mb-1 hover:bg-gray-100"><div class="flex items-center"><div class="w-8 h-8 bg-blue-100 text-blue-500 rounded flex items-center justify-center mr-2 shrink-0"><i class="fa-solid fa-link"></i></div><div class="overflow-hidden"><div class="text-xs font-bold text-gray-500 uppercase truncate">${item.meta}</div><div class="text-sm text-blue-600 truncate">${item.text}</div></div></div></a></div>` : `<span class="${item.bought ? 'line-through text-gray-400' : ''} flex-1">${item.text}</span>`; return `<div class="flex items-start bg-white p-3 rounded shadow-sm border border-gray-100 group"><button onclick="toggleShop(${item.id})" class="mr-3 mt-1 text-xl ${item.bought ? 'text-green-500' : 'text-gray-300'}"><i class="fa-solid ${item.bought ? 'fa-square-check' : 'fa-square'}"></i></button>${content}${item.bought ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded ml-2 whitespace-nowrap">å·²è³¼</span>' : ''}<button onclick="deleteShopItem(${item.id})" class="ml-2 mt-1 text-gray-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button></div>`; }).join(''); }

        // --- Info & Food Logic (UPDATED FOR TABS) ---
        let qrCodes = JSON.parse(localStorage.getItem('trip_qrcodes')) || [];
        function initInfo() { renderHotels(); renderQRs(); }
        function renderHotels() { document.getElementById('hotelInfo').innerHTML = hotels.map(h => `<div class="pb-2 border-b border-gray-100 last:border-0"><div class="text-xs font-bold bg-gray-200 inline-block px-1 rounded text-gray-600 mb-1">${h.date}</div><div class="font-bold text-base text-muji-accent">${h.name}</div><div class="text-xs text-gray-500 mt-1">${h.address}</div><div class="flex gap-3 mt-2"><button onclick="openMap('${h.address}')" class="text-blue-500 text-xs underline">åœ°åœ–</button>${h.tel ? `<a href="tel:${h.tel}" class="text-blue-500 text-xs underline">æ’¥æ‰“é›»è©±</a>` : ''}</div></div>`).join(''); }
        function toggleAccordion(id) { document.getElementById(id).classList.toggle('hidden'); }
        function addQRCode(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function (e) { qrCodes.push(e.target.result); localStorage.setItem('trip_qrcodes', JSON.stringify(qrCodes)); renderQRs(); }; reader.readAsDataURL(input.files[0]); } }
        function renderQRs() { document.getElementById('qrContainer').innerHTML = qrCodes.map((src, idx) => `<div class="relative group"><img src="${src}" class="w-full rounded border border-gray-200" onclick="showFullImg('${src}')"><button onclick="deleteQR(${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-80"><i class="fa-solid fa-xmark"></i></button></div>`).join(''); }
        function deleteQR(idx) { if(confirm('åˆªé™¤?')) { qrCodes.splice(idx, 1); localStorage.setItem('trip_qrcodes', JSON.stringify(qrCodes)); renderQRs(); } }
        
        // --- NEW FOOD LOGIC WITH TABS ---
        function initFood() {
            const tabContainer = document.getElementById('food-day-tabs');
            const listContainer = document.getElementById('food-list');
            let tabsHtml = '';
            let listHtml = '';

            foodData.forEach((section, index) => {
                // Shorten title for tab (e.g., "Day 1-3")
                let shortTitle = section.day.split(':')[0]; // Gets "Day 1-3"
                if(shortTitle.length > 8) shortTitle = 'D' + shortTitle.replace('Day ', '');

                // Tab Button
                tabsHtml += `<button onclick="scrollToFoodSection(${index})" class="food-tab-btn px-4 py-2 rounded-full text-sm font-bold border border-muji-border bg-white text-gray-500 whitespace-nowrap transition-colors flex-shrink-0" id="food-btn-${index}">${shortTitle}</button>`;

                // List Section
                listHtml += `<div id="food-section-${index}" class="scroll-mt-custom">
                    <h3 class="font-bold text-lg mb-3 border-b border-gray-200 pb-1 text-muji-accent sticky top-36 bg-muji-bg py-2 z-10 opacity-95">${section.day}</h3>
                    <div class="space-y-4">`;
                    
                section.spots.forEach(spot => {
                     // Check if address is a link to adjust display
                     let addrDisplay = spot.address.startsWith('http') ? '<span class="text-blue-500 underline">ğŸ“ é»æ“Šé–‹å•Ÿåœ°åœ–</span>' : `<i class="fa-solid fa-map-pin mr-1"></i> ${spot.address}`;
                     
                     listHtml += `<div class="muji-card p-0 flex flex-col"><div class="p-4"><div class="flex justify-between items-start"><div><span class="text-xs font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded">${spot.type}</span><h4 class="font-bold text-lg mt-1">${spot.name}</h4></div><button onclick="openMap('${spot.address}')" class="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-location-arrow text-sm"></i></button></div><p class="text-sm text-gray-500 mt-2 cursor-pointer" onclick="openMap('${spot.address}')">${addrDisplay}</p>${spot.tel ? `<p class="text-sm text-gray-500"><i class="fa-solid fa-phone mr-1"></i> ${spot.tel}</p>` : ''}${spot.note ? `<div class="mt-3 text-sm bg-gray-50 p-2 rounded text-gray-600">"${spot.note}"</div>` : ''}</div></div>`;
                });
                listHtml += `</div></div>`;
            });

            tabContainer.innerHTML = tabsHtml;
            listContainer.innerHTML = listHtml;
            
            // Highlight first tab by default
            updateFoodTabs(0);
        }

        function scrollToFoodSection(index) {
            document.getElementById(`food-section-${index}`).scrollIntoView({behavior: 'smooth', block: 'start'});
            updateFoodTabs(index);
        }
        
        function updateFoodTabs(activeIndex) {
            document.querySelectorAll('.food-tab-btn').forEach((btn, idx) => {
                if(idx === activeIndex) {
                    btn.classList.remove('bg-white', 'text-gray-500', 'border-muji-border');
                    btn.classList.add('bg-muji-accent', 'text-white', 'border-muji-accent');
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    btn.classList.add('bg-white', 'text-gray-500', 'border-muji-border');
                    btn.classList.remove('bg-muji-accent', 'text-white', 'border-muji-accent');
                }
            });
        }
    </script>
</body>
</html>
